<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>US Census Data Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #dbeafe 0%, #c7d2fe 100%);
            min-height: 100vh; padding: 24px;
        }
        .container { max-width: 1280px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 32px; }
        .title { font-size: 2.5rem; font-weight: bold; color: #1f2937; margin-bottom: 8px; }
        .subtitle { font-size: 1.25rem; color: #6b7280; }
        .total-pop {
            display: inline-block; background: white; border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 16px; margin-top: 16px;
        }
        .total-pop-number { font-size: 2rem; font-weight: bold; color: #2563eb; }
        .total-pop-label { color: #6b7280; }
        .loading, .error {
            display: flex; align-items: center; justify-content: center;
            min-height: 100vh; flex-direction: column;
        }
        .spinner {
            border: 3px solid #f3f4f6; border-top: 3px solid #2563eb; border-radius: 50%;
            width: 48px; height: 48px; animation: spin 1s linear infinite; margin-bottom: 16px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tabs { display: flex; justify-content: center; margin-bottom: 32px; }
        .tab-container {
            background: white; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 4px; display: flex;
        }
        .tab {
            padding: 12px 24px; border-radius: 6px; font-weight: 500; cursor: pointer;
            transition: all 0.2s; color: #6b7280;
        }
        .tab:hover { background: #f9fafb; }
        .tab.active { background: #2563eb; color: white; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .content {
            background: white; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 24px;
        }
        .section-title {
            font-size: 1.5rem; font-weight: bold; color: #1f2937; margin-bottom: 24px; text-align: center;
        }
        .chart-container { margin-bottom: 32px; }
        .chart-title { font-size: 1.125rem; font-weight: 600; color: #374151; margin-bottom: 16px; }
        .chart-wrapper { position: relative; height: 400px; margin-bottom: 24px; }
        .grid { display: grid; gap: 32px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); }
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px; margin-top: 32px;
        }
        .stat-card { border-radius: 8px; padding: 16px; text-align: center; }
        .stat-number { font-size: 1.5rem; font-weight: bold; margin-bottom: 4px; }
        .stat-label { color: #6b7280; }
        .red-bg { background: #fef2f2; } .red-text { color: #dc2626; }
        .orange-bg { background: #fff7ed; } .orange-text { color: #ea580c; }
        .yellow-bg { background: #fefce8; } .yellow-text { color: #eab308; }
        .green-bg { background: #f0fdf4; } .green-text { color: #16a34a; }
        .map-container {
            max-width: 800px; margin: 0 auto; background: white; border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 24px;
        }
        .map-legend { display: flex; justify-content: center; margin-bottom: 24px; }
        .legend-box {
            background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 16px;
        }
        .legend-title {
            font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 12px;
            text-align: center;
        }
        .legend-gradient { display: flex; align-items: center; gap: 8px; }
        .gradient-bar { display: flex; }
        .gradient-segment { width: 32px; height: 16px; }
        .legend-labels {
            display: flex; justify-content: space-between; margin-top: 4px;
            font-size: 0.75rem; color: #6b7280;
        }
        .state-grid {
            display: grid; grid-template-columns: repeat(12, 1fr); gap: 2px;
            max-width: 800px; margin: 0 auto; font-size: 0.75rem;
        }
        .state-tile {
            padding: 8px; border-radius: 4px; text-align: center; color: white;
            font-weight: 500; cursor: pointer; transition: opacity 0.2s;
        }
        .state-tile:hover { opacity: 0.8; }
        .data-export { display: flex; justify-content: center; gap: 16px; margin-bottom: 16px; }
        .btn {
            padding: 8px 16px; border-radius: 8px; font-weight: 500; cursor: pointer;
            transition: background-color 0.2s; border: none; color: white;
        }
        .btn-blue { background: #2563eb; } .btn-blue:hover { background: #1d4ed8; }
        .btn-green { background: #16a34a; } .btn-green:hover { background: #15803d; }
        .data-display { background: #f9fafb; border-radius: 8px; padding: 16px; margin-bottom: 24px; }
        .data-textarea {
            width: 100%; height: 256px; padding: 12px; border: 1px solid #d1d5db;
            border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.875rem;
        }
        .footer { text-align: center; margin-top: 32px; color: #6b7280; }
        .gender-stats {
            display: grid; grid-template-columns: 1fr 1fr; gap: 32px; align-items: center;
        }
        .gender-card {
            background: linear-gradient(135deg, #faf5ff 0%, #fce7f3 100%);
            border-radius: 8px; padding: 24px; margin-bottom: 24px;
        }
        .gender-name { font-size: 1.25rem; font-weight: 600; color: #1f2937; margin-bottom: 8px; }
        .gender-population { font-size: 2rem; font-weight: bold; color: #7c3aed; margin-bottom: 4px; }
        .gender-percentage { font-size: 1.125rem; color: #6b7280; margin-bottom: 12px; }
        .progress-bar { background: white; border-radius: 9999px; height: 12px; overflow: hidden; }
        .progress-fill {
            background: #7c3aed; height: 100%; border-radius: 9999px; transition: width 1s ease;
        }
        .ratio-card {
            background: linear-gradient(135deg, #dbeafe 0%, #c7d2fe 100%);
            border-radius: 8px; padding: 24px;
        }
        .ratio-title { font-size: 1.125rem; font-weight: 600; color: #1f2937; margin-bottom: 8px; }
        .ratio-value { font-size: 1.5rem; font-weight: bold; color: #2563eb; }
        .ratio-label { color: #6b7280; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p style="font-size: 1.125rem; color: #6b7280;">Click "Use Sample Data" to start!</p>
        </div>
        
        <div id="dashboard" class="hidden">
            <div class="header">
                <h1 class="title">üá∫üá∏ US Census Data Dashboard</h1>
                <p class="subtitle">American Community Survey 2023</p>
                <div class="total-pop">
                    <p class="total-pop-number" id="totalPopulation">334,914,896</p>
                    <p class="total-pop-label">Total US Population</p>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab-container">
                    <div class="tab active" onclick="showTab('age')">üìä Age</div>
                    <div class="tab" onclick="showTab('states')">üèõÔ∏è States</div>
                    <div class="tab" onclick="showTab('map')">üó∫Ô∏è Map</div>
                    <div class="tab" onclick="showTab('gender')">üë• Gender</div>
                </div>
            </div>
            
            <div class="content">
                <div id="age-tab">
                    <h2 class="section-title">üìà Age Distribution Across the United States</h2>
                    <div class="grid grid-2">
                        <div class="chart-container">
                            <h3 class="chart-title">Population by Age Group</h3>
                            <div class="chart-wrapper"><canvas id="ageChart"></canvas></div>
                        </div>
                        <div class="chart-container">
                            <h3 class="chart-title">Age Group Percentages</h3>
                            <div class="chart-wrapper"><canvas id="agePieChart"></canvas></div>
                        </div>
                    </div>
                </div>
                
                <div id="states-tab" class="hidden">
                    <h2 class="section-title">üèõÔ∏è Top States by Population</h2>
                    <div class="grid grid-2">
                        <div class="chart-container">
                            <h3 class="chart-title">Population by Gender</h3>
                            <div class="chart-wrapper"><canvas id="statesChart"></canvas></div>
                        </div>
                        <div class="chart-container">
                            <h3 class="chart-title">Hispanic/Latino % & Total Population</h3>
                            <div class="chart-wrapper"><canvas id="hispanicChart"></canvas></div>
                        </div>
                    </div>
                </div>
                
                <div id="map-tab" class="hidden">
                    <h2 class="section-title">üó∫Ô∏è Hispanic or Latino Population by State</h2>
                    
                    <div class="map-legend">
                        <div class="legend-box">
                            <h3 class="legend-title">Hispanic or Latino Population (%)</h3>
                            <div class="legend-gradient">
                                <span style="font-size: 0.75rem; color: #6b7280;">0%</span>
                                <div class="gradient-bar">
                                    <div class="gradient-segment" style="background: #fefce8;"></div>
                                    <div class="gradient-segment" style="background: #fef08a;"></div>
                                    <div class="gradient-segment" style="background: #fde047;"></div>
                                    <div class="gradient-segment" style="background: #facc15;"></div>
                                    <div class="gradient-segment" style="background: #eab308;"></div>
                                    <div class="gradient-segment" style="background: #f59e0b;"></div>
                                    <div class="gradient-segment" style="background: #ea580c;"></div>
                                    <div class="gradient-segment" style="background: #dc2626;"></div>
                                </div>
                                <span style="font-size: 0.75rem; color: #6b7280;">50%+</span>
                            </div>
                            <div class="legend-labels"><span>Low</span><span>High</span></div>
                        </div>
                    </div>
                    
                    <div class="data-export">
                        <button class="btn btn-blue" onclick="copyToClipboard()">üìã Copy Data</button>
                        <button class="btn btn-green" onclick="toggleDataDisplay()">üìÑ Show Data</button>
                    </div>
                    
                    <div id="dataDisplay" class="data-display hidden">
                        <h3 style="font-size: 1.125rem; font-weight: 600; color: #374151; margin-bottom: 8px;">Tab-Delimited Data</h3>
                        <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 12px;">Copy and save as .txt or import into Excel:</p>
                        <textarea id="csvData" class="data-textarea" readonly></textarea>
                    </div>
                    
                    <div class="map-container">
                        <div id="usMap" class="state-grid"></div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card red-bg">
                            <p class="stat-number red-text" id="high-hispanic">6</p>
                            <p class="stat-label">States 25%+ Hispanic/Latino</p>
                        </div>
                        <div class="stat-card orange-bg">
                            <p class="stat-number orange-text" id="med-high-hispanic">6</p>
                            <p class="stat-label">States 15-24%</p>
                        </div>
                        <div class="stat-card yellow-bg">
                            <p class="stat-number yellow-text" id="med-hispanic">26</p>
                            <p class="stat-label">States 5-14%</p>
                        </div>
                        <div class="stat-card green-bg">
                            <p class="stat-number green-text" id="low-hispanic">12</p>
                            <p class="stat-label">States under 5%</p>
                        </div>
                    </div>
                </div>
                
                <div id="gender-tab" class="hidden">
                    <h2 class="section-title">üë• Gender Distribution</h2>
                    <div class="gender-stats">
                        <div class="chart-wrapper"><canvas id="genderChart"></canvas></div>
                        <div>
                            <div id="genderCards"></div>
                            <div class="ratio-card">
                                <h3 class="ratio-title">Gender Ratio</h3>
                                <p class="ratio-value" id="genderRatio">97.1</p>
                                <p class="ratio-label">Males per 100 females</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="footer">
                <p>üìä Data source: US Census Bureau - American Community Survey 2023</p>
            </div>
        </div>
    </div>

    <script>
        // Auto-load sample data on page load
        var sampleData = '"Label (Grouping)","United States!!Estimate","California!!Estimate","Texas!!Estimate","Florida!!Estimate","New York!!Estimate"\n' +
        '"    Total population","334,914,896","38,965,193","30,503,301","22,610,726","19,571,216"\n' +
        '"        Male","164,968,876","19,478,102","15,191,777","11,073,083","9,421,478"\n' +
        '"        Female","169,946,020","19,487,091","15,311,524","11,537,643","10,149,738"\n' +
        '"    Under 5 years","19,481,714","2,333,009","2,139,311","1,168,513","1,054,250"\n' +
        '"    5 to 9 years","20,166,706","2,440,726","2,213,412","1,198,387","1,111,729"\n' +
        '"    10 to 14 years","20,547,935","2,499,012","2,267,077","1,223,446","1,150,084"\n' +
        '"    15 to 19 years","21,067,875","2,573,964","2,354,859","1,269,508","1,189,471"\n' +
        '"    20 to 24 years","21,807,874","2,656,127","2,384,951","1,306,775","1,231,746"\n' +
        '"    25 to 34 years","45,652,204","5,540,198","4,826,550","2,823,179","2,651,285"\n' +
        '"    35 to 44 years","42,923,467","5,162,446","4,468,154","2,627,533","2,467,068"\n' +
        '"    45 to 54 years","40,477,030","4,816,967","3,970,789","2,559,956","2,412,978"\n' +
        '"    55 to 59 years","22,325,503","2,657,866","2,101,569","1,486,827","1,314,742"\n' +
        '"    60 to 64 years","21,283,305","2,543,398","1,999,669","1,451,414","1,261,458"\n' +
        '"    65 to 74 years","32,838,236","3,856,780","2,896,471","2,428,542","1,895,863"\n' +
        '"    75 to 84 years","17,254,605","1,958,754","1,483,734","1,238,978","1,024,442"\n' +
        '"    85 years and over","6,083,442","691,946","496,695","427,868","406,100"\n' +
        '"Hispanic or Latino (of any race)","65,140,277","15,760,437","12,135,688","6,196,762","3,872,146"';

        var censusData = null;
        var charts = {};
        
        function getHispanicColor(percentage) {
            if (percentage >= 40) return '#dc2626';
            if (percentage >= 30) return '#ea580c';
            if (percentage >= 20) return '#f59e0b';
            if (percentage >= 15) return '#eab308';
            if (percentage >= 10) return '#facc15';
            if (percentage >= 5) return '#fde047';
            return '#fefce8';
        }
        
        function showTab(tabName) {
            var tabs = document.querySelectorAll('[id$="-tab"]');
            for (var i = 0; i < tabs.length; i++) tabs[i].classList.add('hidden');
            
            var tabButtons = document.querySelectorAll('.tab');
            for (var i = 0; i < tabButtons.length; i++) tabButtons[i].classList.remove('active');
            
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            event.target.classList.add('active');
            renderChartsForTab(tabName);
        }
        
        function renderChartsForTab(tabName) {
            if (!censusData) return;
            switch(tabName) {
                case 'age': renderAgeCharts(); break;
                case 'states': renderStatesCharts(); break;
                case 'gender': renderGenderCharts(); break;
            }
        }
        
        function renderAgeCharts() {
            var ageCtx = document.getElementById('ageChart').getContext('2d');
            if (charts.ageChart) charts.ageChart.destroy();
            
            charts.ageChart = new Chart(ageCtx, {
                type: 'bar',
                data: {
                    labels: censusData.ageGroups.map(function(g) { return g.age; }),
                    datasets: [{
                        label: 'Male', data: censusData.ageGroups.map(function(g) { return g.malePopulation; }),
                        backgroundColor: '#3b82f6', stack: 'Stack 0',
                    }, {
                        label: 'Female', data: censusData.ageGroups.map(function(g) { return g.femalePopulation; }),
                        backgroundColor: '#ec4899', stack: 'Stack 0',
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { maxRotation: 45 } },
                        y: { ticks: { callback: function(value) { return (value / 1000000).toFixed(0) + 'M'; } } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            var agePieCtx = document.getElementById('agePieChart').getContext('2d');
            if (charts.agePieChart) charts.agePieChart.destroy();
            
            charts.agePieChart = new Chart(agePieCtx, {
                type: 'pie',
                data: {
                    labels: censusData.ageGroups.map(function(g) { return g.age + ': ' + g.percentage + '%'; }),
                    datasets: [{
                        data: censusData.ageGroups.map(function(g) { return g.population; }),
                        backgroundColor: ['#8884d8', '#82ca9d', '#ffc658', '#ff7c7c', '#8dd1e1', '#d084d0', '#87ceeb', '#ffa07a', '#98fb98', '#dda0dd', '#ffb347', '#87cefa', '#f0e68c']
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: { callbacks: { label: function(context) { return context.label + ': ' + context.parsed.toLocaleString(); } } }
                    }
                }
            });
        }
        
        function renderStatesCharts() {
            var statesCtx = document.getElementById('statesChart').getContext('2d');
            if (charts.statesChart) charts.statesChart.destroy();
            
            charts.statesChart = new Chart(statesCtx, {
                type: 'bar',
                data: {
                    labels: censusData.topStates.map(function(s) { return s.state; }),
                    datasets: [{
                        label: 'Male', data: censusData.topStates.map(function(s) { return s.malePopulationM; }),
                        backgroundColor: '#3b82f6', stack: 'Stack 0',
                    }, {
                        label: 'Female', data: censusData.topStates.map(function(s) { return s.femalePopulationM; }),
                        backgroundColor: '#ec4899', stack: 'Stack 0',
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { maxRotation: 45 } },
                        y: { ticks: { callback: function(value) { return value + 'M'; } } }
                    },
                    plugins: {
                        tooltip: { callbacks: { label: function(context) { return context.dataset.label + ': ' + context.parsed.y + 'M'; } } }
                    }
                }
            });
            
            var hispanicCtx = document.getElementById('hispanicChart').getContext('2d');
            if (charts.hispanicChart) charts.hispanicChart.destroy();
            
            charts.hispanicChart = new Chart(hispanicCtx, {
                type: 'bar',
                data: {
                    labels: censusData.topStates.map(function(s) { return s.state; }),
                    datasets: [{
                        label: 'Total Population (M)', data: censusData.topStates.map(function(s) { return s.populationM; }),
                        backgroundColor: '#1e40af', yAxisID: 'y',
                    }, {
                        label: 'Hispanic/Latino %', data: censusData.topStates.map(function(s) { return s.hispanicPercentage; }),
                        backgroundColor: '#93c5fd', yAxisID: 'y1',
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { maxRotation: 45 } },
                        y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Population (M)' }, ticks: { callback: function(value) { return value + 'M'; } } },
                        y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Hispanic/Latino %' }, ticks: { callback: function(value) { return value + '%'; } }, grid: { drawOnChartArea: false } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.datasetIndex === 0 ? 'Population: ' + context.parsed.y + 'M' : 'Hispanic/Latino: ' + context.parsed.y + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderGenderCharts() {
            var genderCtx = document.getElementById('genderChart').getContext('2d');
            if (charts.genderChart) charts.genderChart.destroy();
            
            charts.genderChart = new Chart(genderCtx, {
                type: 'pie',
                data: {
                    labels: censusData.genderData.map(function(g) { return g.gender + ': ' + g.percentage + '%'; }),
                    datasets: [{ data: censusData.genderData.map(function(g) { return g.population; }), backgroundColor: ['#0088fe', '#00c49f'] }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: { callbacks: { label: function(context) { return context.label + ': ' + context.parsed.toLocaleString(); } } }
                    }
                }
            });
            
            var genderCardsContainer = document.getElementById('genderCards');
            genderCardsContainer.innerHTML = '';
            
            for (var i = 0; i < censusData.genderData.length; i++) {
                var item = censusData.genderData[i];
                var card = document.createElement('div');
                card.className = 'gender-card';
                card.innerHTML = '<h3 class="gender-name">' + item.gender + '</h3>' +
                    '<p class="gender-population">' + item.population.toLocaleString() + '</p>' +
                    '<p class="gender-percentage">' + item.percentage + '% of population</p>' +
                    '<div class="progress-bar"><div class="progress-fill" style="width: ' + item.percentage + '%"></div></div>';
                genderCardsContainer.appendChild(card);
            }
            
            if (censusData.genderData.length >= 2) {
                var ratio = (censusData.genderData[0].population / censusData.genderData[1].population * 100).toFixed(1);
                document.getElementById('genderRatio').textContent = ratio;
            }
        }
        
        function renderMap() {
            var mapContainer = document.getElementById('usMap');
            mapContainer.innerHTML = '';
            
            // Complete state data with Hispanic/Latino percentages - defined locally to avoid scope issues
            var stateHispanicData = {
                'Alabama': 4.9, 'Alaska': 9.2, 'Arizona': 29.5, 'Arkansas': 12.7, 'California': 40.4,
                'Colorado': 22.4, 'Connecticut': 17.6, 'Delaware': 11.7, 'Florida': 27.4, 'Georgia': 10.8,
                'Hawaii': 10.7, 'Idaho': 11.9, 'Illinois': 18.6, 'Indiana': 8.3, 'Iowa': 7.2,
                'Kansas': 12.5, 'Kentucky': 4.6, 'Louisiana': 4.7, 'Maine': 1.7, 'Maryland': 10.9,
                'Massachusetts': 12.3, 'Michigan': 5.8, 'Minnesota': 6.8, 'Mississippi': 3.4, 'Missouri': 4.7,
                'Montana': 5.1, 'Nebraska': 11.6, 'Nevada': 28.7, 'New Hampshire': 4.3, 'New Jersey': 24.6,
                'New Mexico': 51.2, 'New York': 19.8, 'North Carolina': 10.4, 'North Dakota': 4.2,
                'Ohio': 4.3, 'Oklahoma': 14.6, 'Oregon': 14.5, 'Pennsylvania': 8.1, 'Rhode Island': 18.1,
                'South Carolina': 6.5, 'South Dakota': 3.8, 'Tennessee': 6.1, 'Texas': 39.8,
                'Utah': 14.7, 'Vermont': 1.9, 'Virginia': 10.2, 'Washington': 13.0, 'West Virginia': 0.7,
                'Wisconsin': 7.6, 'Wyoming': 13.5
            };
            
            // Create a proper US map layout with all 50 states
            var stateAbbreviations = {
                'Alabama': 'AL', 'Alaska': 'AK', 'Arizona': 'AZ', 'Arkansas': 'AR', 'California': 'CA',
                'Colorado': 'CO', 'Connecticut': 'CT', 'Delaware': 'DE', 'Florida': 'FL', 'Georgia': 'GA',
                'Hawaii': 'HI', 'Idaho': 'ID', 'Illinois': 'IL', 'Indiana': 'IN', 'Iowa': 'IA',
                'Kansas': 'KS', 'Kentucky': 'KY', 'Louisiana': 'LA', 'Maine': 'ME', 'Maryland': 'MD',
                'Massachusetts': 'MA', 'Michigan': 'MI', 'Minnesota': 'MN', 'Mississippi': 'MS', 'Missouri': 'MO',
                'Montana': 'MT', 'Nebraska': 'NE', 'Nevada': 'NV', 'New Hampshire': 'NH', 'New Jersey': 'NJ',
                'New Mexico': 'NM', 'New York': 'NY', 'North Carolina': 'NC', 'North Dakota': 'ND', 'Ohio': 'OH',
                'Oklahoma': 'OK', 'Oregon': 'OR', 'Pennsylvania': 'PA', 'Rhode Island': 'RI', 'South Carolina': 'SC',
                'South Dakota': 'SD', 'Tennessee': 'TN', 'Texas': 'TX', 'Utah': 'UT', 'Vermont': 'VT',
                'Virginia': 'VA', 'Washington': 'WA', 'West Virginia': 'WV', 'Wisconsin': 'WI', 'Wyoming': 'WY'
            };
            
            // US Map layout (simplified grid representation)
            var mapLayout = [
                // Row 1 - Alaska and Hawaii (separate)
                ['AK', '', '', '', '', '', '', '', 'HI', '', '', ''],
                // Row 2 - Northern tier
                ['', 'WA', 'ID', 'MT', 'ND', 'MN', 'WI', 'MI', 'NY', 'VT', 'NH', 'ME'],
                // Row 3 - Northern states
                ['OR', 'NV', 'WY', 'SD', 'IA', 'IL', 'IN', 'OH', 'PA', 'MA', 'RI', 'CT'],
                // Row 4 - Central states
                ['CA', 'UT', 'CO', 'NE', 'KS', 'MO', 'KY', 'WV', 'VA', 'MD', 'DE', 'NJ'],
                // Row 5 - Southern tier
                ['', 'AZ', 'NM', 'OK', 'AR', 'TN', 'NC', 'SC', 'GA', 'FL', '', ''],
                // Row 6 - Deep South
                ['', '', 'TX', 'LA', 'MS', 'AL', '', '', '', '', '', '']
            ];
            
            // Create the map grid
            mapContainer.style.gridTemplateColumns = 'repeat(12, 1fr)';
            mapContainer.style.gridTemplateRows = 'repeat(6, 50px)';
            mapContainer.style.gap = '2px';
            
            for (var row = 0; row < mapLayout.length; row++) {
                for (var col = 0; col < mapLayout[row].length; col++) {
                    var stateAbbr = mapLayout[row][col];
                    var tile = document.createElement('div');
                    
                    if (stateAbbr === '') {
                        // Empty space
                        tile.style.backgroundColor = 'transparent';
                        tile.style.border = 'none';
                    } else {
                        // Find full state name and data
                        var stateName = null;
                        for (var fullName in stateAbbreviations) {
                            if (stateAbbreviations[fullName] === stateAbbr) {
                                stateName = fullName;
                                break;
                            }
                        }
                        
                        if (stateName && stateHispanicData[stateName] !== undefined) {
                            var percentage = stateHispanicData[stateName];
                            tile.className = 'state-tile';
                            tile.style.backgroundColor = getHispanicColor(percentage);
                            tile.textContent = stateAbbr;
                            tile.title = stateName + ': ' + percentage + '% Hispanic/Latino';
                            
                            // Add click handler for more info
                            tile.onclick = function(stateName, percentage) {
                                return function() {
                                    alert(stateName + '\nHispanic/Latino Population: ' + percentage + '%');
                                };
                            }(stateName, percentage);
                        }
                    }
                    
                    mapContainer.appendChild(tile);
                }
            }
            
            // Update statistics for all 50 states
            var highCount = 0, medHighCount = 0, medCount = 0, lowCount = 0;
            
            for (var stateName in stateHispanicData) {
                var percentage = stateHispanicData[stateName];
                if (percentage >= 25) highCount++;
                else if (percentage >= 15) medHighCount++;
                else if (percentage >= 5) medCount++;
                else lowCount++;
            }
            
            document.getElementById('high-hispanic').textContent = highCount;
            document.getElementById('med-high-hispanic').textContent = medHighCount;
            document.getElementById('med-hispanic').textContent = medCount;
            document.getElementById('low-hispanic').textContent = lowCount;
        }
        
        function generateCSVData() {
            // Local state data to avoid scope issues
            var stateHispanicData = {
                'Alabama': 4.9, 'Alaska': 9.2, 'Arizona': 29.5, 'Arkansas': 12.7, 'California': 40.4,
                'Colorado': 22.4, 'Connecticut': 17.6, 'Delaware': 11.7, 'Florida': 27.4, 'Georgia': 10.8,
                'Hawaii': 10.7, 'Idaho': 11.9, 'Illinois': 18.6, 'Indiana': 8.3, 'Iowa': 7.2,
                'Kansas': 12.5, 'Kentucky': 4.6, 'Louisiana': 4.7, 'Maine': 1.7, 'Maryland': 10.9,
                'Massachusetts': 12.3, 'Michigan': 5.8, 'Minnesota': 6.8, 'Mississippi': 3.4, 'Missouri': 4.7,
                'Montana': 5.1, 'Nebraska': 11.6, 'Nevada': 28.7, 'New Hampshire': 4.3, 'New Jersey': 24.6,
                'New Mexico': 51.2, 'New York': 19.8, 'North Carolina': 10.4, 'North Dakota': 4.2,
                'Ohio': 4.3, 'Oklahoma': 14.6, 'Oregon': 14.5, 'Pennsylvania': 8.1, 'Rhode Island': 18.1,
                'South Carolina': 6.5, 'South Dakota': 3.8, 'Tennessee': 6.1, 'Texas': 39.8,
                'Utah': 14.7, 'Vermont': 1.9, 'Virginia': 10.2, 'Washington': 13.0, 'West Virginia': 0.7,
                'Wisconsin': 7.6, 'Wyoming': 13.5
            };
            
            var csvContent = ['State\tHispanic or Latino Population (%)'];
            
            // Sort states alphabetically and add all 50 states
            var sortedStates = [];
            for (var stateName in stateHispanicData) {
                sortedStates.push({ name: stateName, percentage: stateHispanicData[stateName] });
            }
            
            sortedStates.sort(function(a, b) { return a.name.localeCompare(b.name); });
            
            for (var i = 0; i < sortedStates.length; i++) {
                csvContent.push(sortedStates[i].name + '\t' + sortedStates[i].percentage);
            }
            
            return csvContent.join('\n');
        }
        
        function copyToClipboard() {
            var csvData = generateCSVData();
            navigator.clipboard.writeText(csvData).then(function() {
                alert('üìã Data copied to clipboard!');
            }).catch(function() {
                toggleDataDisplay();
            });
        }
        
        function toggleDataDisplay() {
            var dataDisplay = document.getElementById('dataDisplay');
            var textarea = document.getElementById('csvData');
            
            if (dataDisplay.classList.contains('hidden')) {
                dataDisplay.classList.remove('hidden');
                textarea.value = generateCSVData();
            } else {
                dataDisplay.classList.add('hidden');
            }
        }
        
        function processData(fileContent) {
            var parseResult = Papa.parse(fileContent, { header: true, dynamicTyping: false, skipEmptyLines: true });
            
            // Process age groups
            var ageLabels = ["Under 5 years", "5 to 9 years", "10 to 14 years", "15 to 19 years", "20 to 24 years", "25 to 34 years", "35 to 44 years", "45 to 54 years", "55 to 59 years", "60 to 64 years", "65 to 74 years", "75 to 84 years", "85 years and over"];
            var ageGroups = [];
            
            for (var i = 0; i < ageLabels.length; i++) {
                var ageLabel = ageLabels[i];
                var row = null;
                for (var j = 0; j < parseResult.data.length; j++) {
                    var r = parseResult.data[j];
                    var label = r["Label (Grouping)"];
                    if (label && label.trim() === ageLabel) { row = r; break; }
                }
                
                if (row && row["United States!!Estimate"]) {
                    var estimate = parseInt(row["United States!!Estimate"].replace(/,/g, ''));
                    if (!isNaN(estimate)) {
                        ageGroups.push({
                            age: ageLabel.replace(' years', '').replace(' and over', '+'),
                            population: estimate, percentage: 0, malePopulation: 0, femalePopulation: 0
                        });
                    }
                }
            }
            
            // Get gender data
            var totalMaleRow = null, totalFemaleRow = null;
            for (var i = 0; i < parseResult.data.length; i++) {
                var r = parseResult.data[i];
                if (r["Label (Grouping)"] && r["Label (Grouping)"].trim() === "Male") totalMaleRow = r;
                if (r["Label (Grouping)"] && r["Label (Grouping)"].trim() === "Female") totalFemaleRow = r;
            }
            
            var overallMaleRatio = 0.49;
            if (totalMaleRow && totalFemaleRow && totalMaleRow["United States!!Estimate"] && totalFemaleRow["United States!!Estimate"]) {
                var totalMale = parseInt(totalMaleRow["United States!!Estimate"].replace(/,/g, ''));
                var totalFemale = parseInt(totalFemaleRow["United States!!Estimate"].replace(/,/g, ''));
                if (!isNaN(totalMale) && !isNaN(totalFemale)) {
                    overallMaleRatio = totalMale / (totalMale + totalFemale);
                }
            }
            
            // Calculate gender breakdown
            for (var i = 0; i < ageGroups.length; i++) {
                ageGroups[i].malePopulation = Math.round(ageGroups[i].population * overallMaleRatio);
                ageGroups[i].femalePopulation = ageGroups[i].population - ageGroups[i].malePopulation;
            }
            
            var totalPop = 0;
            for (var i = 0; i < ageGroups.length; i++) totalPop += ageGroups[i].population;
            for (var i = 0; i < ageGroups.length; i++) {
                ageGroups[i].percentage = ((ageGroups[i].population / totalPop) * 100).toFixed(1);
            }
            
            // Process state data
            var totalPopRow = null, malePopRow = null, femalePopRow = null, hispanicPopRow = null;
            for (var i = 0; i < parseResult.data.length; i++) {
                var r = parseResult.data[i], label = r["Label (Grouping)"];
                if (label && label.trim() === "Total population") totalPopRow = r;
                if (label && label.trim() === "Male") malePopRow = r;
                if (label && label.trim() === "Female") femalePopRow = r;
                if (label && label.trim() === "Hispanic or Latino (of any race)") hispanicPopRow = r;
            }
            
            var statePopulations = [], allStatesData = [];
            if (totalPopRow && malePopRow && femalePopRow && hispanicPopRow) {
                var stateColumns = [];
                for (var i = 0; i < parseResult.meta.fields.length; i++) {
                    var field = parseResult.meta.fields[i];
                    if (field.includes('!!Estimate') && !field.includes('United States') && !field.includes('Puerto Rico') && !field.includes('Margin of Error')) {
                        stateColumns.push(field);
                    }
                }
                
                for (var i = 0; i < stateColumns.length; i++) {
                    var column = stateColumns[i];
                    var stateName = column.replace('!!Estimate', '');
                    var totalPopulation = totalPopRow[column];
                    var malePopulation = malePopRow[column];
                    var femalePopulation = femalePopRow[column];
                    var hispanicPopulation = hispanicPopRow[column];
                    
                    if (totalPopulation && totalPopulation !== "" && hispanicPopulation && hispanicPopulation !== "") {
                        var numTotal = parseInt(totalPopulation.toString().replace(/,/g, ''));
                        var numHispanic = parseInt(hispanicPopulation.toString().replace(/,/g, ''));
                        
                        if (!isNaN(numTotal) && !isNaN(numHispanic) && numTotal > 0) {
                            var hispanicPercentage = parseFloat(((numHispanic / numTotal) * 100).toFixed(1));
                            allStatesData.push({ state: stateName, hispanicPercentage: hispanicPercentage, hispanicPopulation: numHispanic, totalPopulation: numTotal });
                            
                            if (malePopulation && femalePopulation && malePopulation !== "" && femalePopulation !== "") {
                                var numMale = parseInt(malePopulation.toString().replace(/,/g, ''));
                                var numFemale = parseInt(femalePopulation.toString().replace(/,/g, ''));
                                if (!isNaN(numMale) && !isNaN(numFemale)) {
                                    statePopulations.push({
                                        state: stateName, population: numTotal, populationM: parseFloat((numTotal / 1000000).toFixed(1)),
                                        malePopulation: numMale, femalePopulation: numFemale,
                                        malePopulationM: parseFloat((numMale / 1000000).toFixed(1)),
                                        femalePopulationM: parseFloat((numFemale / 1000000).toFixed(1)),
                                        hispanicPopulation: numHispanic, hispanicPercentage: hispanicPercentage
                                    });
                                }
                            }
                        }
                    }
                }
            }
            
            statePopulations.sort(function(a, b) { return b.population - a.population; });
            var topStates = statePopulations.slice(0, 15);
            
            // Gender data
            var genderData = [];
            if (totalMaleRow && totalFemaleRow && totalMaleRow["United States!!Estimate"] && totalFemaleRow["United States!!Estimate"]) {
                var maleCount = parseInt(totalMaleRow["United States!!Estimate"].replace(/,/g, ''));
                var femaleCount = parseInt(totalFemaleRow["United States!!Estimate"].replace(/,/g, ''));
                if (!isNaN(maleCount) && !isNaN(femaleCount)) {
                    genderData.push(
                        { gender: 'Male', population: maleCount, percentage: parseFloat(((maleCount / totalPop) * 100).toFixed(1)) },
                        { gender: 'Female', population: femaleCount, percentage: parseFloat(((femaleCount / totalPop) * 100).toFixed(1)) }
                    );
                }
            }
            
            censusData = { ageGroups: ageGroups, topStates: topStates, allStatesData: allStatesData, genderData: genderData, totalPopulation: totalPop };
            
            document.getElementById('totalPopulation').textContent = totalPop.toLocaleString();
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            renderAgeCharts();
            renderMap();
        }
        
        // Auto-load sample data and initialize map immediately
        window.addEventListener('load', function() {
            // Update statistics immediately with correct values
            document.getElementById('high-hispanic').textContent = '6';
            document.getElementById('med-high-hispanic').textContent = '6';
            document.getElementById('med-hispanic').textContent = '26';
            document.getElementById('low-hispanic').textContent = '12';
            
            setTimeout(function() {
                processData(sampleData);
            }, 1000);
        });
    </script>
</body>
</html>